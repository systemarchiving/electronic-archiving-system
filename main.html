<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الرئيسية - نظام الأرشفة الإلكترونية</title>
  <style>
    :root {
      --primary:   #186e2b;
      --secondary: #bf9930;
      --light:     #ffffff;
      --dark:      #121212;
      --bg:        #f4f4f4;
      --text:      #333333;
      --text-light:#ffffff;
    }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:Arial,sans-serif;
      direction:rtl;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      padding-top:80px;
    }
    header {
      position:fixed; top:0; left:0; right:0; height:60px;
      background:var(--primary);
      color:var(--text-light);
      display:flex; align-items:center; justify-content:center;
      z-index:100;
    }
    header img { height:40px; margin-left:10px; }
    header h1 { font-size:1.5rem; }

    nav {
      position:fixed; top:60px; left:0; bottom:0; width:240px;
      background:var(--primary); padding-top:20px;
      box-shadow:2px 0 5px rgba(0,0,0,.1);
      text-align:left;
    }
    nav a {
      display:flex; align-items:center; padding:12px 20px;
      color:var(--text-light); font-size:.95rem;
      text-decoration:none;
      transition:background .2s;
    }
    nav a.active, nav a:hover {
      background:var(--secondary);
    }
    .icon { margin-left:10px; font-size:1.1rem; }

    .stats-grid {
      display:flex; justify-content:center; gap:20px; margin-top:20px;
    }
    .stat-card {
      background:var(--light); padding:20px;
      border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1);
      width:150px;
    }
    .stat-card h2 { margin-bottom:8px; color:var(--primary); }
    .stat-card p  { font-size:.9rem; color:#555; }

    .actions {
      margin-top:30px;
    }
    .actions button {
      background:var(--secondary);
      color:var(--text-light);
      border:none; border-radius:4px;
      padding:10px 20px; margin:0 10px;
      font-size:1rem; cursor:pointer;
      transition:background .2s;
    }
    .actions button:hover {
      background:#a17c28;
    }

    .modal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,.5);
      justify-content:center; align-items:center; z-index:200;
    }
    .modal-content {
      background:var(--light); border-radius:8px;
      padding:20px; max-width:90%; max-height:90%;
      overflow:auto; position:relative;
    }
    .modal-content .close {
      position:absolute; top:10px; right:10px;
      font-size:1.5rem; cursor:pointer;
    }
    #chart { max-width:100%; height:300px; }
    #report-list {
      text-align:left; max-height:400px; overflow:auto;
      margin-bottom:15px;
    }
    #report-list li { margin:6px 0; }

    footer {
      position:fixed; bottom:0; left:240px; right:0; height:40px;
      background:var(--primary);
      color:var(--text-light);
      display:flex; align-items:center; justify-content:center;
      font-size:.85rem; z-index:100;
    }
    body.dark-mode {
      background:var(--dark); color:var(--text-light);
    }
    body.dark-mode header,
    body.dark-mode nav,
    body.dark-mode footer {
      background:#0f4318;
    }
  </style>
</head>
<body>

  <!-- رأس الصفحة -->
  <header>
    <img src="ber-ALmedinh.png" alt="شعار الجمعية">
    <h1>نظام الأرشفة الإلكترونية</h1>
  </header>

  <!-- القائمة الجانبية -->
  <nav>
    <a href="main.html" class="active"><span class="icon">🏠</span>الرئيسية</a>
    <a href="sections.html"><span class="icon">📁</span>الأقسام</a>
    <a href="archive.html"><span class="icon">📂</span>الأرشيف</a>
    <a href="users.html"><span class="icon">👤</span>المستخدمون</a>
    <a href="settings.html"><span class="icon">⚙️</span>الإعدادات</a>
  </nav>

  <!-- بطاقات الإحصائيات -->
  <div class="stats-grid">
    <div class="stat-card">
      <h2 id="stat-sections">0</h2>
      <p>عدد الأقسام</p>
    </div>
    <div class="stat-card">
      <h2 id="stat-files">0</h2>
      <p>عدد الملفات</p>
    </div>
    <div class="stat-card">
      <h2 id="stat-size">0 MB</h2>
      <p>حجم الملفات</p>
    </div>
  </div>

  <!-- أزرار التقارير والإحصائيات -->
  <div class="actions">
    <button id="btn-stats">إظهار الإحصائيات</button>
    <button id="btn-report">عرض التقرير</button>
  </div>

  <!-- مودال الإحصائيات -->
  <div id="modal-stats" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-stats">&times;</span>
      <h3>إحصائيات</h3>
      <select id="stats-range">
        <option value="daily">يومي</option>
        <option value="monthly">شهري</option>
        <option value="yearly">سنوي</option>
      </select>
      <canvas id="chart"></canvas>
      <button onclick="window.print()">طباعة</button>
    </div>
  </div>

  <!-- مودال التقرير -->
  <div id="modal-report" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-report">&times;</span>
      <h3>تقرير</h3>
      <select id="report-range">
        <option value="daily">يومي</option>
        <option value="weekly">أسبوعي</option>
        <option value="monthly">شهري</option>
        <option value="yearly">سنوي</option>
      </select>
      <ul id="report-list"></ul>
      <button onclick="window.print()">طباعة</button>
    </div>
  </div>

  <!-- فوتر -->
  <footer>جميع الحقوق محفوظة © 2025 الجمعية</footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // قراءة البيانات من localStorage
    const sections = JSON.parse(localStorage.getItem('sections')||'[]');
    const files    = JSON.parse(localStorage.getItem('files')||'[]');

    // تحديث بطاقات الإحصائيات
    function updateStats() {
      document.getElementById('stat-sections').textContent = sections.length;
      document.getElementById('stat-files').textContent    = files.length;
      const totalBytes = files.reduce((sum,f)=>sum + (f.sizeBytes||0), 0);
      document.getElementById('stat-size').textContent     =
        (totalBytes/1024/1024).toFixed(2) + ' MB';
    }
    updateStats();

    // تجهيز سجل الملفات لتقارير/إحصائيات
    function getRecords() {
      return files.map(f=>({
        filename: f.filename,
        section: sections.find(s=>s.id===f.sectionId)?.name||'—',
        date: new Date(f.archivedAt)
      }));
    }

    // فتح/إغلاق مودال
    function openModal(id){ document.getElementById(id).style.display='flex'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    document.querySelectorAll('.close').forEach(el=>
      el.onclick = ()=> closeModal(el.dataset.close)
    );

    // رسم المخطط
    let chart;
    function renderChart() {
      const range = document.getElementById('stats-range').value;
      const now   = new Date();
      let start;
      if (range==='daily')   start = new Date(now.getFullYear(),now.getMonth(),now.getDate());
      else if(range==='monthly')start = new Date(now.getFullYear(),now.getMonth(),1);
      else                    start = new Date(now.getFullYear(),0,1);

      const buckets = {};
      getRecords().forEach(r=>{
        if (r.date >= start) {
          let key;
          if(range==='daily')     key = r.date.getHours()+':00';
          else if(range==='monthly')key = `${r.date.getDate()}/${r.date.getMonth()+1}`;
          else                     key = `${r.date.getMonth()+1}/${r.date.getFullYear()}`;
          buckets[key] = (buckets[key]||0) + 1;
        }
      });

      const labels = Object.keys(buckets).sort((a,b)=>{
        return new Date(range==='daily'? start.toDateString()+' '+a : 
          range==='monthly'? `${a.split('/')[1]}/${a.split('/')[0]}/${now.getFullYear()}` :
          `${a}`) -
               new Date(range==='daily'? start.toDateString()+' '+b :
          range==='monthly'? `${b.split('/')[1]}/${b.split('/')[0]}/${now.getFullYear()}` :
          `${b}`);
      });
      const data = labels.map(l=>buckets[l]);

      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'عدد الملفات', data }] },
        options: { responsive:true }
      });
    }

    document.getElementById('btn-stats').onclick    = ()=>{ openModal('modal-stats'); renderChart(); };
    document.getElementById('stats-range').onchange = renderChart;

    // ملء التقرير
    function renderReport() {
      const range = document.getElementById('report-range').value;
      const now   = new Date();
      const recs  = getRecords().filter(r=>{
        if(range==='daily')   return r.date.toDateString()===now.toDateString();
        if(range==='weekly')  return r.date >= new Date(now.getTime() - 7*24*3600e3);
        if(range==='monthly') return r.date.getMonth()===now.getMonth() && r.date.getFullYear()===now.getFullYear();
        if(range==='yearly')  return r.date.getFullYear()===now.getFullYear();
      });
      const ul = document.getElementById('report-list');
      ul.innerHTML = '';
      if (!recs.length) return ul.innerHTML = '<li>لا توجد بيانات</li>';
      recs.sort((a,b)=>b.date - a.date).forEach(r=>{
        const li = document.createElement('li');
        li.textContent = `${r.filename} (${r.section}) – ${r.date.toLocaleString()}`;
        ul.appendChild(li);
      });
    }

    document.getElementById('btn-report').onclick      = ()=>{ openModal('modal-report'); renderReport(); };
    document.getElementById('report-range').onchange   = renderReport;
  </script>
</body>
</html>
